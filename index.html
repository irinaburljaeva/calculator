<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ШАГАЙ ДОМА — Калькуляторы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --red: #CF2C02;
      --yellow: #FFBA08;
      --orange: #E85D04;
      --bg: #FFFFFF;
      --ink: #111111;
      --soft: #6B6B6B;
      --border: #E5E5E5;
      --radius: 18px;
      --shadow-soft: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-strong: 0 12px 32px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .page {
      width: 100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 24px;
    }

    .title {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 24px;
    }

    .menu {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .menu-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 14px;
      text-align: center;
      cursor: pointer;
      transition: 0.15s ease;
      box-shadow: var(--shadow-soft);
    }
    .menu-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-strong);
    }
    .menu-card h2 {
      font-size: 18px;
      margin: 0 0 6px;
    }
    .menu-card span {
      font-size: 12px;
      color: var(--soft);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 9999;
    }
    .modal.active { display: flex; }

    .modal__dialog {
      width: 100%;
      max-width: 520px;
      max-height: 100%;
      background: #fff;
      border-radius: 22px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-strong);
      overflow: hidden;
      position: relative;
    }
    .modal__head {
      padding: 14px 18px;
      background: linear-gradient(135deg, #FFF4D1, #FFE0CF);
      border-bottom: 1px solid #F2F2F2;
      font-weight: 600;
      font-size: 17px;
    }

    .modal__close {
      position: absolute;
      right: 16px;
      top: 12px;
      background: #fff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      border: none;
      cursor: pointer;
      font-size: 18px;
      box-shadow: var(--shadow-soft);
    }

    .modal__body {
      padding: 16px;
      overflow-y: auto;
    }

    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
      gap: 4px;
    }

    .field label { font-size: 14px; }

    .field input,
    .field select {
      padding: 8px 12px;
      font-size: 15px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #FAFAFA;
      outline: none;
    }
    .field input:focus,
    .field select:focus {
      border-color: var(--red);
      background: #fff;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 15px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .btn-red {
      background: var(--red);
      color: #fff;
      box-shadow: 0 6px 16px rgba(207,44,2,0.35);
    }
    .btn-gray {
      background: #eee;
      color: #444;
    }
    .btns {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
    }

    .error {
      color: #C81E1E;
      font-size: 13px;
      margin-top: 4px;
    }

    .box {
      border: 1px solid #FFE5C4;
      background: #FFF8E9;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      margin-top: 8px;
    }

    .food-card {
      border: 1px solid #F1F1F1;
      background: #FFFFFF;
      padding: 10px 14px;
      border-radius: 14px;
      margin-bottom: 8px;
      box-shadow: var(--shadow-soft);
    }
    .food-card-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .food-card-details {
      font-size: 13px;
      color: #444;
    }

    .meal-block {
      margin-bottom: 18px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .meal-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .meal-popup {
      position: absolute;
      background: #fff;
      border-radius: 14px;
      box-shadow: var(--shadow-strong);
      padding: 12px;
      display: none;
      z-index: 999999;
      border: 1px solid #F2F2F2;
    }
    .meal-popup button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      border-radius: 10px;
      background: #FAFAFA;
      border: 1px solid #eee;
      margin-bottom: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .meal-popup button:hover {
      background: #FFF0E0;
      border-color: var(--red);
    }

    .day-summary {
      background: #FFF9EB;
      border: 1px solid #FFE5B6;
      padding: 12px 14px;
      border-radius: 16px;
      margin-top: 18px;
      font-size: 14px;
    }
    .day-summary strong { color: var(--red); }

    .cal-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      background: #FFF4E0;
      padding: 4px;
      border-radius: 14px;
    }
    .cal-tab {
      flex: 1;
      border: none;
      background: transparent;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      color: #666;
    }
    .cal-tab-active {
      background: #fff;
      box-shadow: var(--shadow-soft);
      color: var(--ink);
      font-weight: 600;
    }

    .suggestions-box {
      position: absolute;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
      padding: 6px 0;
      display: none;
      z-index: 99999;
      max-height: 220px;
      overflow-y: auto;
      font-size: 14px;
    }
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
    }
    .suggestion-item:hover { background: #FFF2E0; }
  </style>
</head>

<body>

  <div class="page">
    <div class="title">ШАГАЙ ДОМА — калькуляторы</div>

    <div class="menu">
      <button class="menu-card" data-open="modal-bmi">
        <h2>ИМТ</h2>
        <span>быстрая оценка индекса массы</span>
      </button>

      <button class="menu-card" data-open="modal-calories">
        <h2>Калории и КБЖУ</h2>
        <span>дневная норма и рацион</span>
      </button>
    </div>
  </div>

  <!-- МОДАЛКА ИМТ -->
  <div class="modal" id="modal-bmi">
    <div class="modal__dialog">
      <button class="modal__close" data-close>✕</button>
      <div class="modal__head">Калькулятор ИМТ</div>

      <div class="modal__body">
        <form id="bmiForm">
          <div class="field">
            <label for="bmiWeight">Вес (кг)</label>
            <input id="bmiWeight" type="number" min="30" max="250" step="0.1" required>
          </div>

          <div class="field">
            <label for="bmiHeight">Рост (см)</label>
            <input id="bmiHeight" type="number" min="120" max="220" step="1" required>
          </div>

          <div class="btns">
            <button type="submit" class="btn btn-red">Рассчитать</button>
            <button type="button" class="btn btn-gray" id="bmiReset">Сброс</button>
          </div>

          <div id="bmiError" class="error" style="display:none;"></div>
          <div id="bmiResult" class="box" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- МОДАЛКА КАЛОРИЙ -->
  <div class="modal" id="modal-calories">
    <div class="modal__dialog">
      <button class="modal__close" data-close>✕</button>
      <div class="modal__head">Калории, КБЖУ и рацион</div>

      <div class="modal__body">

        <div class="cal-tabs">
          <button class="cal-tab cal-tab-active" data-cal-tab="norm">Ваша норма на день</button>
          <button class="cal-tab" data-cal-tab="day">Калории за день</button>
        </div>

        <!-- Вкладка 1 -->
        <div id="calTab-norm">
          <form id="normForm">

            <div class="field">
              <label for="sex">Пол</label>
              <select id="sex">
                <option value="female">Женщина</option>
                <option value="male">Мужчина</option>
              </select>
            </div>

            <div class="field">
              <label for="age">Возраст</label>
              <input id="age" type="number" min="14" max="90" required>
            </div>

            <div class="field">
              <label for="weightNorm">Вес (кг)</label>
              <input id="weightNorm" type="number" min="30" max="250" step="0.1" required>
            </div>

            <div class="field">
              <label for="heightNorm">Рост (см)</label>
              <input id="heightNorm" type="number" min="120" max="220" required>
            </div>

            <div class="field">
              <label for="activity">Как примерно проходит ваш день?</label>
              <select id="activity">
                <option value="1.2">Сидячая работа, почти нет движения</option>
                <option value="1.375">Есть лёгкие тренировки 1–3 раза в неделю</option>
                <option value="1.55" selected>Тренировки 3–4 раза в неделю</option>
                <option value="1.7">Тренировки 5–7 раз в неделю или активная работа</option>
                <option value="1.9">Очень высокая физическая нагрузка, спорт</option>
              </select>
            </div>

            <div class="field">
              <label for="stepsPerDay">Сколько шагов в день вы проходите в среднем?</label>
              <input id="stepsPerDay" type="number" min="0" placeholder="Например: 6000">
            </div>

            <div class="field">
              <label for="stepMinutesDay">Сколько минут шагательных тренировок в день?</label>
              <input id="stepMinutesDay" type="number" min="0" placeholder="Например: 20–40 минут">
            </div>

            <div class="field">
              <label for="hormones">Есть ли диагностированные гормональные нарушения?</label>
              <select id="hormones">
                <option value="no" selected>Нет</option>
                <option value="yes">Да</option>
              </select>
            </div>

            <div class="field">
              <label for="goal">Цель</label>
              <select id="goal">
                <option value="lossModerate">Похудение: умеренный темп</option>
                <option value="lossSlow">Похудение: медленный темп</option>
                <option value="maintain">Поддержание веса</option>
                <option value="gain">Набор массы</option>
              </select>
            </div>

            <div class="btns">
              <button type="submit" class="btn btn-red">Рассчитать</button>
              <button type="button" class="btn btn-gray" id="normReset">Сброс</button>
            </div>

            <div id="normError" class="error" style="display:none;"></div>
            <div id="normResult" class="box" style="display:none;"></div>

          </form>
        </div>

        <!-- Вкладка 2 -->
        <div id="calTab-day" style="display:none;">

          <div class="field" style="position:relative;">
            <label for="foodName">Название продукта/блюда</label>
            <input id="foodName" type="text" placeholder="Например: яблоко, гречка, суп сырный…" autocomplete="off">
          </div>

          <p style="font-size:13px; color:#777; margin-top:-6px; margin-bottom:8px;">
            ℹ️ Подсказки могут появляться на разных языках, потому что мы используем международную базу продуктов OpenFoodFacts.
            Если вашего варианта нет в списке — введите его вручную.
          </p>

          <div id="suggestions" class="suggestions-box"></div>

          <div class="field">
            <label for="foodPer100">Калории (ккал) на 100 г</label>
            <input id="foodPer100" type="number" placeholder="Если не подставилось автоматически, введите вручную">
          </div>

          <div class="field">
            <label for="foodGrams">Сколько граммов вы съели?</label>
            <input id="foodGrams" type="number" min="1" placeholder="Например: 120">
          </div>

          <div class="field">
            <label>Белки, жиры, углеводы (на 100 г)</label>
            <input id="protein100" type="number" placeholder="Белки (если не подставилось автоматически, введите вручную)">
            <input id="fat100" type="number" placeholder="Жиры (если не подставилось автоматически, введите вручную)">
            <input id="carb100" type="number" placeholder="Углеводы (если не подставилось автоматически, введите вручную)">
          </div>

          <div class="btns">
            <button type="button" id="calcFood" class="btn btn-red">Добавить</button>
            <button type="button" id="clearDay" class="btn btn-gray">Очистить день</button>
          </div>

          <div id="mealPopup" class="meal-popup">
            <button data-meal="breakfast">Добавить в Завтрак</button>
            <button data-meal="lunch">Добавить в Обед</button>
            <button data-meal="dinner">Добавить в Ужин</button>
            <button data-meal="snack">Добавить в Перекус</button>
          </div>

          <div class="meal-block">
            <div class="meal-title">Завтрак</div>
            <div id="list-breakfast"></div>
          </div>

          <div class="meal-block">
            <div class="meal-title">Обед</div>
            <div id="list-lunch"></div>
          </div>

          <div class="meal-block">
            <div class="meal-title">Ужин</div>
            <div id="list-dinner"></div>
          </div>

          <div class="meal-block">
            <div class="meal-title">Перекус</div>
            <div id="list-snack"></div>
          </div>

          <div id="daySummary" class="day-summary" style="display:none;"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* Модалки */
    document.querySelectorAll("[data-open]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.getElementById(btn.dataset.open).classList.add("active");
      });
    });
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", () => {
        btn.closest(".modal").classList.remove("active");
      });
    });
    document.querySelectorAll(".modal").forEach(modal => {
      modal.addEventListener("click", e => {
        if (e.target === modal) modal.classList.remove("active");
      });
    });

    /* Табы */
    const calTabs = document.querySelectorAll(".cal-tab");
    function activateCalTab(name) {
      calTabs.forEach(btn => {
        btn.classList.toggle("cal-tab-active", btn.dataset.calTab === name);
      });
      document.getElementById("calTab-norm").style.display = name === "norm" ? "block" : "none";
      document.getElementById("calTab-day").style.display = name === "day" ? "block" : "none";
    }
    calTabs.forEach(btn => btn.addEventListener("click", () => activateCalTab(btn.dataset.calTab)));
    activateCalTab("norm");

    /* ИМТ */
    const bmiForm = document.getElementById("bmiForm");
    const bmiError = document.getElementById("bmiError");
    const bmiResult = document.getElementById("bmiResult");

    function bmiStatus(bmi) {
      if (bmi <= 16) return "выраженный дефицит массы";
      if (bmi < 18.5) return "недостаточная масса тела";
      if (bmi < 25) return "норма";
      if (bmi < 30) return "избыточная масса (предожирение)";
      if (bmi < 35) return "ожирение";
      if (bmi < 40) return "резкое ожирение";
      return "очень резкое ожирение";
    }

    bmiForm.addEventListener("submit", e => {
      e.preventDefault();
      bmiError.style.display = "none";
      bmiResult.style.display = "none";

      const w = parseFloat(document.getElementById("bmiWeight").value);
      const h = parseFloat(document.getElementById("bmiHeight").value) / 100;

      if (!w || !h || w <= 0 || h <= 0) {
        bmiError.textContent = "Проверьте введённые значения.";
        bmiError.style.display = "block";
        return;
      }

      const bmi = w / (h * h);
      bmiResult.innerHTML = `Ваш ИМТ: <strong>${bmi.toFixed(1)}</strong> — ${bmiStatus(bmi)}.`;
      bmiResult.style.display = "block";
    });

    document.getElementById("bmiReset").addEventListener("click", () => {
      bmiForm.reset();
      bmiError.style.display = "none";
      bmiResult.style.display = "none";
    });

    /* Норма калорий и localStorage */
    let dailyNorm = null;
    const normForm = document.getElementById("normForm");
    const normError = document.getElementById("normError");
    const normResult = document.getElementById("normResult");

    const STORAGE_NORM_KEY = "sd_daily_norm_v1";
    const STORAGE_MEALS_KEY = "sd_meals_v1";

    let mealsData = {
      breakfast: [],
      lunch: [],
      dinner: [],
      snack: []
    };

    function calcBMR(sex, weight, height, age) {
      return sex === "female"
        ? 10 * weight + 6.25 * height - 5 * age - 161
        : 10 * weight + 6.25 * height - 5 * age + 5;
    }

    function saveNormToStorage() {
      try {
        if (dailyNorm != null) localStorage.setItem(STORAGE_NORM_KEY, String(dailyNorm));
        else localStorage.removeItem(STORAGE_NORM_KEY);
      } catch (e) {}
    }

    function saveMealsToStorage() {
      try {
        localStorage.setItem(STORAGE_MEALS_KEY, JSON.stringify(mealsData));
      } catch (e) {}
    }

    function renderMeals() {
      ["breakfast", "lunch", "dinner", "snack"].forEach(meal => {
        const container = document.getElementById("list-" + meal);
        if (!container) return;
        container.innerHTML = "";
        mealsData[meal].forEach(product => {
          const div = document.createElement("div");
          div.className = "food-card";
          div.innerHTML = `
            <div class="food-card-title">${product.name} • ${product.grams} г</div>
            <div class="food-card-details">
              Калории: <strong>${product.kcal}</strong><br>
              Б: ${product.p} г |
              Ж: ${product.f} г |
              У: ${product.c} г
            </div>
          `;
          container.appendChild(div);
        });
      });
    }

    function loadStateFromStorage() {
      try {
        const savedNorm = localStorage.getItem(STORAGE_NORM_KEY);
        if (savedNorm) {
          const n = Number(savedNorm);
          if (!isNaN(n)) {
            dailyNorm = n;
            normResult.innerHTML =
              `Ваша ориентировочная норма: <strong>${dailyNorm} ккал</strong> в день.`;
            normResult.style.display = "block";
          }
        }
        const savedMeals = localStorage.getItem(STORAGE_MEALS_KEY);
        if (savedMeals) {
          const parsed = JSON.parse(savedMeals);
          if (parsed && typeof parsed === "object") {
            mealsData = Object.assign(mealsData, parsed);
          }
        }
      } catch (e) {}
      renderMeals();
      updateDaySummary();
    }

    normForm.addEventListener("submit", e => {
      e.preventDefault();
      normError.style.display = "none";
      normResult.style.display = "none";

      const sex = document.getElementById("sex").value;
      const age = Number(document.getElementById("age").value);
      const weight = Number(document.getElementById("weightNorm").value);
      const height = Number(document.getElementById("heightNorm").value);
      const activity = Number(document.getElementById("activity").value);
      const steps = Number(document.getElementById("stepsPerDay").value) || 0;
      const stepMinutesDay = Number(document.getElementById("stepMinutesDay").value) || 0;
      const hormones = document.getElementById("hormones").value === "yes";
      const goal = document.getElementById("goal").value;

      if (!age || !weight || !height) {
        normError.textContent = "Заполните все обязательные поля.";
        normError.style.display = "block";
        return;
      }

      const bmr = calcBMR(sex, weight, height, age);

      // 1) Базовый КФА — только по общему уровню активности
      let kfa = activity;
      if (kfa > 1.9) kfa = 1.9;

      let tdee = bmr * kfa;

      // 2) Мужчинам +100 ккал
      if (sex === "male") tdee += 100;

      // 3) Дополнительные калории за шаги и шагательные тренировки
      let extraKcal = 0;

      // Шаги: мягкая поправка NEAT
      if (steps >= 4000 && steps < 7000) extraKcal += 40;
      else if (steps >= 7000 && steps < 10000) extraKcal += 80;
      else if (steps >= 10000) extraKcal += 130;

      // Шагательные тренировки (минуты в день)
      if (stepMinutesDay >= 10 && stepMinutesDay < 20) extraKcal += 30;
      else if (stepMinutesDay >= 20 && stepMinutesDay < 40) extraKcal += 70;
      else if (stepMinutesDay >= 40) extraKcal += 120;

      tdee += extraKcal;

      // 4) Цель (дефицит/профицит)
      let deficit = 0;
      if (goal === "lossModerate") deficit = 500;
      else if (goal === "lossSlow") deficit = 700;
      else if (goal === "gain") tdee += 200;

      // Если есть гормональные нарушения – дефицит смягчаем
      if (deficit > 0) {
        if (hormones) deficit = Math.round(deficit * 0.8);
        tdee -= deficit;
      }

      dailyNorm = Math.round(tdee);

      // Эффективный вес (формула Дёренберга, цель 10%/15% жира)
      const heightM = height / 100;
      const sexFlag = sex === "male" ? 1 : 0;
      const targetBF = sex === "male" ? 10 : 15;
      let bmiTarget = (targetBF + 10.8 * sexFlag + 5.4 - 0.23 * age) / 1.2;
      if (bmiTarget < 18) bmiTarget = 18;
      const effectiveWeight = Math.round(bmiTarget * heightM * heightM);

      const proteinG = Math.round(effectiveWeight * 1.6);
      const fatG = Math.round(effectiveWeight * 0.8);
      const proteinKcal = proteinG * 4;
      const fatKcal = fatG * 9;
      let carbsKcal = dailyNorm - proteinKcal - fatKcal;
      if (carbsKcal < 0) carbsKcal = 0;
      const carbsG = Math.round(carbsKcal / 4);

      let text = `
        Ваша ориентировочная норма: <strong>${dailyNorm} ккал</strong> в день.<br><br>
        Ориентировочное распределение КБЖУ:<br>
        • Белки: <strong>${proteinG} г</strong> в день<br>
        • Жиры: <strong>${fatG} г</strong> в день<br>
        • Углеводы: <strong>${carbsG} г</strong> в день<br><br>
        Эффективный вес для вашего роста (при ~${sex === "male" ? 10 : 15}% жира): <strong>${effectiveWeight} кг</strong>.
      `;

      if (hormones) {
        text += `<br><br>Вы указали, что есть гормональные нарушения — дефицит сделан мягче, чтобы не перегружать организм.`;
      }

      normResult.innerHTML = text;
      normResult.style.display = "block";

      saveNormToStorage();
      updateDaySummary();
    });

    document.getElementById("normReset").addEventListener("click", () => {
      normForm.reset();
      normError.style.display = "none";
      normResult.style.display = "none";
      dailyNorm = null;
      saveNormToStorage();
      updateDaySummary();
    });

    /* OpenFoodFacts подсказки */
    const foodNameInput = document.getElementById("foodName");
    const suggestionsBox = document.getElementById("suggestions");
    let lastSearchTime = 0;
    let debounceTimer = null;

    async function searchOFF(query) {
      const now = Date.now();
      if (now - lastSearchTime < 700) return [];
      lastSearchTime = now;

      const url =
        "https://world.openfoodfacts.org/cgi/search.pl?" +
        "search_terms=" + encodeURIComponent(query) +
        "&search_simple=1&action=process" +
        "&fields=product_name,product_name_ru,nutriments" +
        "&json=1";

      try {
        const res = await fetch(url, {
          headers: {
            "User-Agent": "ShagayDomaCalc/1.0 (ira-burljaeva@rambler.ru)"
          }
        });
        const data = await res.json();
        return data.products || [];
      } catch (e) {
        return [];
      }
    }

    function clearSuggestions() {
      suggestionsBox.style.display = "none";
      suggestionsBox.innerHTML = "";
    }

    function showSuggestions(items) {
      suggestionsBox.innerHTML = "";
      if (!items.length) {
        suggestionsBox.style.display = "none";
        return;
      }

      const rect = foodNameInput.getBoundingClientRect();
      suggestionsBox.style.top = rect.bottom + window.scrollY + "px";
      suggestionsBox.style.left = rect.left + "px";
      suggestionsBox.style.width = rect.width + "px";

      items.slice(0, 10).forEach(item => {
        const name = item.product_name_ru || item.product_name || "";
        const n = item.nutriments || {};
        const kcal = n["energy-kcal_100g"];

        if (!name || !kcal) return;

        const d = document.createElement("div");
        d.className = "suggestion-item";
        d.textContent = `${name} — ${kcal} ккал`;

        d.addEventListener("click", () => {
          document.getElementById("foodName").value = name;
          document.getElementById("foodPer100").value = kcal;
          document.getElementById("protein100").value = n.proteins_100g || 0;
          document.getElementById("fat100").value = n.fat_100g || 0;
          document.getElementById("carb100").value = n.carbohydrates_100g || 0;
          clearSuggestions();
        });

        suggestionsBox.appendChild(d);
      });

      suggestionsBox.style.display = "block";
    }

    foodNameInput.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      const q = foodNameInput.value.trim();
      if (q.length < 2) {
        clearSuggestions();
        return;
      }
      debounceTimer = setTimeout(async () => {
        const results = await searchOFF(q);
        showSuggestions(results);
      }, 300);
    });

    document.addEventListener("click", e => {
      if (!suggestionsBox.contains(e.target) && e.target !== foodNameInput) {
        clearSuggestions();
      }
    });

    /* Приёмы пищи */
    const mealPopup = document.getElementById("mealPopup");
    let pendingProduct = null;

    document.getElementById("calcFood").addEventListener("click", () => {
      const name = document.getElementById("foodName").value.trim();
      const grams = Number(document.getElementById("foodGrams").value);
      const kcal100 = Number(document.getElementById("foodPer100").value);
      const p100 = Number(document.getElementById("protein100").value) || 0;
      const f100 = Number(document.getElementById("fat100").value) || 0;
      const c100 = Number(document.getElementById("carb100").value) || 0;

      if (!name || !grams || !kcal100) return;

      pendingProduct = {
        name,
        grams,
        kcal: Math.round(kcal100 * grams / 100),
        p: +(p100 * grams / 100).toFixed(1),
        f: +(f100 * grams / 100).toFixed(1),
        c: +(c100 * grams / 100).toFixed(1)
      };

      const rect = document.getElementById("calcFood").getBoundingClientRect();
      mealPopup.style.top = rect.bottom + window.scrollY + "px";
      mealPopup.style.left = rect.left + "px";
      mealPopup.style.display = "block";
    });

    document.getElementById("clearDay").addEventListener("click", () => {
      mealsData = {
        breakfast: [],
        lunch: [],
        dinner: [],
        snack: []
      };
      saveMealsToStorage();
      renderMeals();
      updateDaySummary();
    });

    mealPopup.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const meal = btn.dataset.meal;
        if (!pendingProduct) return;
        mealsData[meal].push(pendingProduct);
        pendingProduct = null;
        mealPopup.style.display = "none";
        saveMealsToStorage();
        renderMeals();
        updateDaySummary();
      });
    });

    document.addEventListener("click", e => {
      if (!mealPopup.contains(e.target) && e.target.id !== "calcFood") {
        mealPopup.style.display = "none";
      }
    });

    /* Итог дня */
    function updateDaySummary() {
      let totalKcal = 0;
      let totalP = 0;
      let totalF = 0;
      let totalC = 0;

      ["breakfast", "lunch", "dinner", "snack"].forEach(meal => {
        mealsData[meal].forEach(p => {
          totalKcal += p.kcal;
          totalP += p.p;
          totalF += p.f;
          totalC += p.c;
        });
      });

      const box = document.getElementById("daySummary");

      if (totalKcal === 0) {
        box.style.display = "none";
        return;
      }

      let html = `
        <strong>Итог за день:</strong><br>
        Калории: <strong>${totalKcal}</strong><br>
        Белки: ${totalP.toFixed(1)} г<br>
        Жиры: ${totalF.toFixed(1)} г<br>
        Углеводы: ${totalC.toFixed(1)} г<br><br>
      `;

      if (dailyNorm) {
        const percent = Math.round((totalKcal / dailyNorm) * 100);
        const diff = dailyNorm - totalKcal;
        html += `Это ${percent}% от вашей нормы.<br>`;
        if (diff >= 0)
          html += `Осталось: <strong>${diff} ккал</strong>`;
        else
          html += `Перебор: <strong>${Math.abs(diff)} ккал</strong>`;
      }

      box.innerHTML = html;
      box.style.display = "block";
    }

    loadStateFromStorage();
  </script>

</body>
</html>
